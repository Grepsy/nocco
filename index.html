<!DOCTYPE html />

<html>
<head>
	<title>Nocco.cs</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<link href="nocco.css" rel="stylesheet" media="all" type="text/css" />
	<script src="prettify.js" type="text/javascript"></script>
</head>
<body onload="prettyPrint()">
	<div id="container">
		<div id="background"></div>
			<div id="jump_to">
				Jump To &hellip;
				<div id="jump_wrapper">
					<div id="jump_page">
							<a class="source" href="language.html">
								Language.cs
							</a>
							<a class="source" href="index.html">
								Nocco.cs
							</a>
							<a class="source" href="program.html">
								Program.cs
							</a>
							<a class="source" href="section.html">
								Section.cs
							</a>
							<a class="source" href="templatebase.html">
								TemplateBase.cs
							</a>
							<a class="source" href="properties/assemblyinfo.html">
								Properties\AssemblyInfo.cs
							</a>
					</div>
				</div>
			</div>
		<table cellpadding="0" cellspacing="0">
			<thead>
				<tr>
					<th class="docs">
						<h1>Nocco.cs</h1>
					</th>
					<th class="code"></th>
				</tr>
			</thead>
			<tbody>
					<tr id="section_1">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_1">&#182;</a>
							</div>
							<p><strong>Nocco</strong> is a quick-and-dirty, literate-programming-style documentation
generator. It is a C# port of <a href="http://jashkenas.github.com/docco/">Docco</a>,
which was written by <a href="https://github.com/jashkenas">Jeremy Ashkenas</a> in
Coffescript and runs on node.js.</p>

<p>Nocco produces HTML that displays your comments alongside your code.
Comments are passed through
<a href="http://daringfireball.net/projects/markdown/syntax">Markdown</a>, and code is
highlighted using <a href="http://code.google.com/p/google-code-prettify/">google-code-prettify</a>
syntax highlighting. This page is the result of running Nocco against its
own source files.</p>

<p>Currently, to build Nocco, you'll have to have Visual Studio 2010. The project
depends on <a href="http://code.google.com/p/markdownsharp/">MarkdownSharp</a> and you'll
have to install <a href="http://www.asp.net/mvc/mvc3">.NET MVC 3</a> to get the
System.Web.Razor assembly.</p>

<p>To use Nocco, run it from the command-line:</p>

<pre><code>nocco *.cs
</code></pre>

<p>...will generate linked HTML documentation for the named source files, saving
it into a <code>docs</code> folder.</p>

<p>The <a href="http://github.com/dontangg/nocco">source for Nocco</a> is available on GitHub,
and released under the MIT license.</p>

<p>If <strong>.NET</strong> doesn't run on your platform, or you'd prefer a more convenient
package, get <a href="http://rtomayko.github.com/rocco/">Rocco</a>, the Ruby port that's
available as a gem. If you're writing shell scripts, try
<a href="http://rtomayko.github.com/shocco/">Shocco</a>, a port for the <strong>POSIX shell</strong>.
Both are by <a href="http://github.com/rtomayko">Ryan Tomayko</a>. If Python's more
your speed, take a look at <a href="http://github.com/fitzgen">Nick Fitzgerald</a>'s
<a href="http://fitzgen.github.com/pycco/">Pycco</a>.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
</code></pre>
						</td>
					</tr>
					<tr id="section_2">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_2">&#182;</a>
							</div>
							<p>Import namespaces to allow us to type shorter type names.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>using System;
using System.CodeDom.Compiler;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Web.Razor;

namespace Nocco {
	class Nocco {
		private static string ExecutingDirectory;
		private static List&lt;string&gt; Files;
		private static Type TemplateType;

</code></pre>
						</td>
					</tr>
					<tr id="section_3">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_3">&#182;</a>
							</div>
							<h3>Main Documentation Generation Functions</h3>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
</code></pre>
						</td>
					</tr>
					<tr id="section_4">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_4">&#182;</a>
							</div>
							<p>Generate the documentation for a source file by reading it in, splitting it
up into comment/code sections, highlighting them for the appropriate language,
and merging them into an HTML template.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static void GenerateDocumentation(string source) {
			var lines = File.ReadAllLines(source);
			var sections = Parse(source, lines);
			Hightlight(source, sections);
			GenerateHtml(source, sections);
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_5">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_5">&#182;</a>
							</div>
							<p>Given a string of source code, parse out each comment and the code that
follows it, and create an individual <code>Section</code> for it.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static List&lt;Section&gt; Parse(string source, string[] lines) {
			List&lt;Section&gt; sections = new List&lt;Section&gt;();
			var language = GetLanguage(source);
			var hasCode = false;
			var docsText = new StringBuilder();
			var codeText = new StringBuilder();

			Action&lt;string, string&gt; save = (string docs, string code) =&gt; sections.Add(new Section() { DocsHtml = docs, CodeHtml = code });

			foreach (var line in lines) {
				if (language.CommentMatcher.IsMatch(line) &amp;&amp; !language.CommentFilter.IsMatch(line)) {
					if (hasCode) {
						save(docsText.ToString(), codeText.ToString());
						hasCode = false;
						docsText = new StringBuilder();
						codeText = new StringBuilder();
					}
					docsText.AppendLine(language.CommentMatcher.Replace(line, &quot;&quot;));
				}
				else {
					hasCode = true;
					codeText.AppendLine(line);
				}
			}
			save(docsText.ToString(), codeText.ToString());

			return sections;
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_6">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_6">&#182;</a>
							</div>
							<p>Prepares a single chunk of code for HTML output and runs the text of its
corresponding comment through <strong>Markdown</strong>, using a C# implementation
called <a href="http://code.google.com/p/markdownsharp/">MarkdownSharp</a>.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static void Hightlight(string source, List&lt;Section&gt; sections) {
			var markdown = new MarkdownSharp.Markdown();

			for (var i=0; i&lt;sections.Count; i++) {
				var section = sections[i];
				section.DocsHtml = markdown.Transform(section.DocsHtml);
				section.CodeHtml = System.Web.HttpUtility.HtmlEncode(section.CodeHtml);
			}
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_7">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_7">&#182;</a>
							</div>
							<p>Once all of the code is finished highlighting, we can generate the HTML file
and write out the documentation. Pass the completed sections into the template
found in <code>Resources/Nocco.cshtml</code></p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static void GenerateHtml(string source, List&lt;Section&gt; sections) {
			int depth;
			var destination = GetDestination(source, out depth);
			
			string pathToRoot = &quot;&quot;;
			for (var i = 0; i &lt; depth; i++)
				pathToRoot = Path.Combine(&quot;..&quot;, pathToRoot);

			var htmlTemplate = Activator.CreateInstance(TemplateType) as TemplateBase;

			htmlTemplate.Title = Path.GetFileName(source);
			htmlTemplate.PathToCss = Path.Combine(pathToRoot, &quot;nocco.css&quot;).Replace(&#39;\\&#39;, &#39;/&#39;);
			htmlTemplate.GetSourcePath = (string s) =&gt; Path.Combine(pathToRoot, Path.ChangeExtension(s.ToLower(), &quot;.html&quot;).Substring(2)).Replace(&#39;\\&#39;, &#39;/&#39;);
			htmlTemplate.Sections = sections;
			htmlTemplate.Sources = Files;
			
			htmlTemplate.Execute();

			File.WriteAllText(destination, htmlTemplate.Buffer.ToString());
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_8">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_8">&#182;</a>
							</div>
							<h3>Helpers &amp; Setup</h3>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
</code></pre>
						</td>
					</tr>
					<tr id="section_9">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_9">&#182;</a>
							</div>
							<p>Setup the Razor templating engine so that we can quickly pass the data in
and generate HTML.</p>

<p>The file <code>Resources\Nocco.cshtml</code> is read and compiled into a new dll
with a type that extends the <code>TemplateBase</code> class. This new assembly is
loaded so that we can create an instance and pass data into it
and generate the HTML.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static Type SetupRazorTemplate() {
			RazorEngineHost host = new RazorEngineHost(new CSharpRazorCodeLanguage());
			host.DefaultBaseClass = typeof(TemplateBase).FullName;
			host.DefaultNamespace = &quot;RazorOutput&quot;;
			host.DefaultClassName = &quot;Template&quot;;
			host.NamespaceImports.Add(&quot;System&quot;);

			GeneratorResults razorResult = null;
			using (var reader = new StreamReader(Path.Combine(ExecutingDirectory, &quot;Resources&quot;, &quot;Nocco.cshtml&quot;))) {
				razorResult = new RazorTemplateEngine(host).GenerateCode(reader);
			}

			var compilerParams = new CompilerParameters {
				GenerateInMemory = true,
				GenerateExecutable = false,
				IncludeDebugInformation = false,
				CompilerOptions = &quot;/target:library /optimize&quot;
			};
			compilerParams.ReferencedAssemblies.Add(typeof(Nocco).Assembly.CodeBase.Replace(&quot;file:///&quot;, &quot;&quot;).Replace(&quot;/&quot;, &quot;\\&quot;));

			var codeProvider = new Microsoft.CSharp.CSharpCodeProvider();
			CompilerResults results = codeProvider.CompileAssemblyFromDom(compilerParams, razorResult.GeneratedCode);

</code></pre>
						</td>
					</tr>
					<tr id="section_10">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_10">&#182;</a>
							</div>
							<p>Check for errors that may have occurred during template generation</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			if (results.Errors.HasErrors) {
				foreach (var err in results.Errors.OfType&lt;CompilerError&gt;().Where(ce =&gt; !ce.IsWarning))
					Console.WriteLine(&quot;Error Compiling Template: ({0}, {1}) {2}&quot;, err.Line, err.Column, err.ErrorText);
			}

			return results.CompiledAssembly.GetType(&quot;RazorOutput.Template&quot;);
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_11">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_11">&#182;</a>
							</div>
							<p>A list of the languages that Nocco supports, mapping the file extension to
the symbol that indicates a comment. To add another language to Nocco's
repertoire, add it here.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static Dictionary&lt;string, Language&gt; Languages = new Dictionary&lt;string, Language&gt; {
			{ &quot;.js&quot;, new Language {
				Name = &quot;javascript&quot;,
				Symbol = &quot;//&quot;
			}},
			{ &quot;.cs&quot;, new Language {
				Name = &quot;csharp&quot;,
				Symbol = &quot;//&quot;
			}},
			{ &quot;.vb&quot;, new Language {
				Name = &quot;vb.net&quot;,
				Symbol = &quot;&#39;&quot;
			}}
		};

</code></pre>
						</td>
					</tr>
					<tr id="section_12">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_12">&#182;</a>
							</div>
							<p>Get the current language we're documenting, based on the extension.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static Language GetLanguage(string source) {
			var extension = Path.GetExtension(source);
			return Languages.ContainsKey(extension) ? Languages[extension] : null;
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_13">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_13">&#182;</a>
							</div>
							<p>Compute the destination HTML path for an input source file path. If the source
is <code>Example.cs</code>, the HTML will be at <code>docs/example.html</code></p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static string GetDestination(string filepath, out int depth) {
			var dirs = Path.GetDirectoryName(filepath).Substring(1).Split(new char[] { Path.DirectorySeparatorChar }, StringSplitOptions.RemoveEmptyEntries);
			depth = dirs.Length;

			var dest = &quot;docs&quot;;
			foreach(var dir in dirs)
				dest = Path.Combine(dest, dir);

			EnsureDirectory(dest);

			return Path.Combine(dest, Path.GetFileNameWithoutExtension(filepath).ToLower() + &quot;.html&quot;);
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_14">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_14">&#182;</a>
							</div>
							<p>Ensure that the destination directory exists.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		private static void EnsureDirectory(string dir) {
			if (!Directory.Exists(dir))
				Directory.CreateDirectory(dir);
		}

</code></pre>
						</td>
					</tr>
					<tr id="section_15">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_15">&#182;</a>
							</div>
							<p>Find all the files that match the pattern(s) passed in as arguments and
generate documentation for each one.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		public static void Generate(string[] targets) {
			if (targets.Length &gt; 0) {
				EnsureDirectory(&quot;docs&quot;);

				ExecutingDirectory = Path.GetDirectoryName(System.Reflection.Assembly.GetExecutingAssembly().Location);
				File.Copy(Path.Combine(ExecutingDirectory, &quot;Resources&quot;, &quot;Nocco.css&quot;), Path.Combine(&quot;docs&quot;, &quot;nocco.css&quot;), true);
				File.Copy(Path.Combine(ExecutingDirectory, &quot;Resources&quot;, &quot;prettify.js&quot;), Path.Combine(&quot;docs&quot;, &quot;prettify.js&quot;), true);

				TemplateType = SetupRazorTemplate();

				Files = new List&lt;string&gt;();
				foreach (var target in targets)
					Files.AddRange(Directory.GetFiles(&quot;.&quot;, target, SearchOption.AllDirectories).Where(filename =&gt; GetLanguage(Path.GetFileName(filename)) != null));

				foreach (var file in Files)
					GenerateDocumentation(file);
			}
		}
	}
}
</code></pre>
						</td>
					</tr>
			</tbody>
		</table>
	</div>
</body>
</html>
